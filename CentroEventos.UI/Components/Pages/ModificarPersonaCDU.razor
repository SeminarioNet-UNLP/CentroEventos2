@inject ModificarPersonaUseCase modificarPersona
@inject ServicioSesion sesion

<div class="row g-3 align-items-center body-custom">
    <div class="row-auto">
        <label for="inputDni" class="col-form-label">DNI</label>
    </div>
    <div class="row-auto">
        <input class="form-control" type="text" placeholder="Default input" aria-label="default input example" @bind-value= "personaView.Dni"> 
    </div>
    <div class="row-auto">
        <label for="inputNombre" class="col-form-label">Nombre</label>
    </div>
    <div class="row-auto">
        <input class="form-control" type="text" placeholder="Default input" aria-label="default input example"@bind-value= "personaView.Nombre">
    </div>
    <div class="row-auto">
        <label for="inputApellido" class="col-form-label">Apellido</label>
    </div>
    <div class="row-auto">
        <input class="form-control" type="text" placeholder="Default input" aria-label="default input example"@bind-value="personaView.Apellido">

    </div>
    <div class="row-auto">
        <label for="inputEmail" class="col-form-label">Email</label>
    </div>
    <div class="row-auto"> 
        <input class="form-control" type="text" placeholder="Default input" aria-label="default input example"@bind-value= "personaView.Email">
    </div>
    <div class="row-auto">
        <label for="inputTelefono" class="col-form-label">Telefono</label>
    </div>
    <div class="row-auto"> 
        <input class="form-control" type="text" placeholder="Default input" aria-label="default input example"@bind-value= "personaView.Telefono">
    </div>
    <Button Color="ButtonColor.Primary" @onclick="Modificar">Guardar Cambios</Button>
    <div>
    @if(alert)
    {
     <Alert Color="AlertColor.Success">
        <h4 class="alert-heading">Modificacion completada</h4>
        <hr>
     </Alert>
    }
    @if(alertDanger)
    {
     <Alert Color="AlertColor.Danger">
        <h4 class="alert-heading">Error:@mensajeError </h4>
        <hr>
     </Alert>
    }
    
    </div>
</div>

@code {

    [Parameter]
    public int idUsuario {get; set;}
    public Persona? personaEditar{get; set;}
    
    private class personaViewModel
    {
        public string? Dni { get; set; }
        public string? Nombre { get; set; }
        public string? Apellido { get; set; }
        public string? Email { get; set; }
        public string? Telefono { get; set; }
    }
    
    personaViewModel personaView = new();
    string? mensajeError;
    bool alert = false;
    bool alertDanger = false;
    protected override void OnInitialized()
    {
        if(personaEditar!= null)
        {
            personaView.Dni=personaEditar.Dni;
            personaView.Nombre = personaEditar.Nombre;
            personaView.Apellido =personaEditar.Apellido;
            personaView.Email =personaEditar.Email;
            personaView.Telefono=personaEditar.Telefono;
        }
      
    }
    private void Modificar()
    {   
        Usuario? usuarioActual = sesion.ObtenerUsuarioActivo();
        
        try 
        {
            if (usuarioActual == null)
            {
                throw new Exception ($"Error en la modificacion de la persona: Inicie sesion.");
            }
            if (!string.IsNullOrEmpty(personaView.Dni) && 
                !string.IsNullOrEmpty(personaView.Nombre) && 
                !string.IsNullOrEmpty(personaView.Apellido) && 
                !string.IsNullOrEmpty(personaView.Email) &&
                !string.IsNullOrEmpty(personaView.Telefono)) 
            {
                List<Permiso> permisos = new List<Permiso> { Permiso.Usuario };
                Persona persona = new Persona(      
                        personaView.Dni,             
                        personaView.Nombre,
                        personaView.Apellido,
                        personaView.Email,
                        personaView.Telefono);

                persona.Id = idUsuario;
                try
                {
                    modificarPersona.Ejecutar(persona, usuarioActual);
                    alert = true;
                }
                catch(Exception ex)
                {
                    alertDanger = true;
                    mensajeError = ex.Message;
                }
            }
        }
        catch (Exception ex) 
        {
            Console.WriteLine($"Error en la modificacion de la persona: {ex.Message}");
        }
    }
}
